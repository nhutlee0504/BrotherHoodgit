@inherits LayoutComponentBase
@inject HttpClient http
@inject IJSRuntime jsruntime
@inject NavigationManager NavigationManager

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
   
</style>
<div class="page">
    <div class="main">
        @*Header*@
        <header>
            <div class="container-fluid" style="padding-left:0px;">
                <nav class="navbar navbar-expand-lg sticky-top  shadow rounded" style="position:fixed; width:100%; 	padding: 10px 20px;">

                    <!-- Logo -->
                    <div class="logo me-5">
                        <a href="#"><img class="rounded-circle" src="/AnhGiaoDien/Logo.jpg" alt="Logo" style="max-width: 100px;"></a>
                    </div>
                    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>

                    <!-- Nội dung của navbar -->
                    <div class="collapse navbar-collapse" id="navbarSupportedContent">
                        <div class="d-flex justify-content-center me-0">
                            <div class="search-box">
                                <button class="btn-search"><i class="fas fa-search"></i></button>
                                <input type="text" class="input-search" style="color:black;border-color:#15ba6d !important; border-radius:15px; font-size:14px; font-family:Arial, Helvetica, sans-serif" placeholder="Nhập thông tin tìm kiếm...">
                            </div>
    
                        </div>
                       
                        <!-- Menu điều hướng -->
                        <ul class="navbar-nav ms-auto flex-column flex-lg-row align-items-center">
                            <li class="nav-item">
                                <a class="nav-link text-center" href="#">
                                    <i class="bi bi-house"></i>
                                    <div>Trang chủ</div>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link text-center" href="sanpham">
                                    <i class="bi bi-box-seam"></i>
                                    <div>Sản phẩm</div>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link text-center" href="/PageGioHang">
                                    <i class="bi bi-basket"></i>
                                    <div>Giỏ hàng</div>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link text-center" href="bill">
                                    <i class="bi bi-receipt"></i>
                                    <div>Hóa đơn</div>
                                </a>
                            </li>
                        </ul>
        

                        <!-- Auth buttons -->
                        <div class="auth-buttons ms-auto d-flex justify-content-center align-items-center">
                            @if (isLoading)
                            {
                                <span>Loading...</span>
                            }
                            else if (!IsLoggedIn)
                            {
                                <a href="register" class="btn btn-success me-2">
                                    <i class="fas fa-user-plus"></i> Đăng ký
                                </a>
                                <a href="login" class="btn btn-dark">
                                    <i class="fas fa-sign-in-alt"></i> Đăng nhập
                                </a>
                            }
                            else
                            {
                                <div class="dropdown user-dropdown">
                                    <a class="user-dropdown-toggle" href="#" role="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-user-circle"></i>
                                    </a>

                                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                                        <!-- Card thông tin người dùng -->
                                        <li>
                                            <div class="card user-info-card">
                                                <div class="row g-0 align-items-center">
                                                   
                                                    <div class="col">
                                                        <div class="card-body py-2">
                                                            <h6 class="card-title mb-1">@accountInfo.FullName</h6>
                                                            <p class="card-text">
                                                                <small class="text-muted">
                                                                    Ví của bạn:
                                                                    @String.Format("{0:N0} VND", accountInfo.PreSystem)
                                                                </small>
                                                            </p>

                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>

                                        <!-- Các chức năng khác -->
                                        <li><a class="dropdown-item" href="/post"><i class="fas fa-plus-circle"></i> Thêm sản phẩm</a></li>
                                        <li>
                                            <a class="dropdown-item" href="/ThongTinNguoiDung/@accountInfo.UserName">
                                                <i class="fas fa-user"></i> Thông tin tài khoản
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" href="/DoiMatKhau">
                                                <i class="fas fa-key"></i> Đổi mật khẩu
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" href="/ThongBao">
                                                <i class="fas fa-bell"></i> Thông báo
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" href="/LichSuHoatDong">
                                                <i class="fas fa-history"></i> Lịch sử hoạt động
                                            </a>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <button class="dropdown-item text-danger" @onclick="Logout">
                                                <i class="fas fa-sign-out-alt"></i> Đăng xuất
                                            </button>
                                        </li>
                                    </ul>
                                </div>
                            }
                        </div>

                    </div>

                </nav>
            </div>

        </header>


        <div class="content" style="margin-top:75px;" ng-app="app">
            @Body
        </div>
       

        @*Footer*@
        <button id="scrollToTopBtn" class="btn btn-primary" style="display: none;">
            <i class="fas fa-arrow-up"></i> Quay lên
        </button>
            <footer>
                 <div class="container-fluid">
                <div class="row">
                    <div class="col-md-3">
                        <div class="group-item text-center">
                            <a href="#"><i class="fab fa-facebook-square text-success" style="font-size:36px"></i></a>
                            <a href="#"><i class="fab fa-instagram text-success" style="font-size:36px"></i></a>
                            <a href="#"><i class="fab fa-youtube text-success" style="font-size:36px"></i></a>
                            <a href="#"><i class="fab fa-linkedin text-success" style="font-size:36px"></i></a>

                        </div>
                    </div>

                    <div class="col-md-9">
                        <div class="row">
                            <div class="col-md-4">
                                <!-- Footer Section 1 -->
                                <h5 style="font-weight:bolder">Trung tâm hỗ trợ khách hàng</h5>
                                <ul>
                                    <li><a href="#">Quy tắc an toàn mua bán</a></li>
                                    <li><a href="#">Các câu hỏi thường gặp</a></li>
                                    <li><a href="#">Q&A</a></li>
                                    <li><a href="#">Liên hệ hỗ trợ</a></li>
                                </ul>
                            </div>
                            <div class="col-md-4">

                                <!-- Footer Section 2 -->
                                <h5 style="font-weight:bolder">Về BrothersHood</h5>
                                <ul>
                                    <li><a href="#">Giới thiệu</a></li>
                                    <li><a href="#">Đánh giá bảo mật</a></li>
                                    <li><a href="#">Giải quyết tranh chấp</a></li>
                                    <li><a href="#">Tuyển dụng</a></li>
                                    <li><a href="#">Truyền thông</a></li>
                                </ul>
                            </div>
                            <div class="col-md-4">
                                <!-- Footer Section 3 -->
                                <h5 style="font-weight:bolder">Resources</h5>
                                <ul>
                                    <li><a href="#">API</a></li>
                                    <li><a href="#">AI API</a></li>
                                    <li><a href="#">Source Web</a></li>
                                    <li><a href="#">Dev tool</a></li>
                                </ul>
                            </div>
                        </div>




                    </div>
                </div>
            </div>
            </footer>
        </div>


</div>
@code {
    private bool isLoading = true;
    private string errorMessage;
    private AccountInfoDto accountInfo;
    private bool IsLoggedIn { get; set; } = false; // Biến để theo dõi trạng thái đăng nhập

    protected override async Task OnInitializedAsync()
    {
        await CheckTokenAndLoadAccountInfo();
    }

    private async Task CheckTokenAndLoadAccountInfo()
    {
        var token = await jsruntime.InvokeAsync<string>("localStorage.getItem", "token");

        if (!string.IsNullOrEmpty(token))
        {
            // Thiết lập token cho yêu cầu HTTP
            http.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            await LoadAccountInfo();        }
        else
        {
            isLoading = false; // Không cần tải thông tin tài khoản
        }
    }

    private async Task LoadAccountInfo()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            var response = await http.GetAsync("api/User/GetMyInfo");

            if (response.IsSuccessStatusCode)
            {
                accountInfo = await response.Content.ReadFromJsonAsync<AccountInfoDto>();
                IsLoggedIn = true; // Đánh dấu là người dùng đã đăng nhập
            }
            else
            {
                errorMessage = await response.Content.ReadAsStringAsync();
                IsLoggedIn = false; // Đánh dấu là người dùng chưa đăng nhập
                await Logout();
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Có lỗi xảy ra: " + ex.Message;
            IsLoggedIn = false; // Đánh dấu là người dùng chưa đăng nhập
        }
        finally
        {
            isLoading = false;
        }
    }

    private class AccountInfoDto
    {
        public string UserName { get; set; }
        public decimal PreSystem { get; set; }
        public string FullName { get; set; }
        public string PhoneNumber { get; set; }
        public string Gender { get; set; }
        public DateTime? Birthday { get; set; }
        public string ImageAccount { get; set; }
    }

    private async Task Logout()
    {
        // Xóa token khỏi local storage và cập nhật trạng thái
        await jsruntime.InvokeVoidAsync("localStorage.removeItem", "token");
        IsLoggedIn = false;
        accountInfo = null; // Đặt lại thông tin tài khoản
        NavigationManager.NavigateTo("/", forceLoad: true);
    }
}