@page "/post"
@using System.ComponentModel.DataAnnotations
@inject HttpClient HttpClient
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@using SanGiaoDich_BrotherHood.Shared.Dto
@using SanGiaoDich_BrotherHood.Shared.Models

<div class="container-fluid">
    <ul class="breadcrumb">
        <li class="breadcrumb-item"><a href="#"><i class="bi bi-house"></i> Trang chủ</a></li>
        <li class="breadcrumb-item"><a href="#">Đăng sản phẩm</a></li>
    </ul>
</div>

<style>
    .image-preview img {
        max-width: 100%;
        max-height: 100%;
        object-fit: cover;
    }
</style>

<h4>Thông tin sản phẩm</h4>

<div class="container">
    <!-- Modal for image error -->
    <div class="modal fade show" style="@(!string.IsNullOrEmpty(ImageError) ? "display: block;" : "display: none;")" tabindex="-1" aria-labelledby="imageErrorModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="imageErrorModalLabel">Lỗi hình ảnh</h5>
                    <button type="button" class="btn-close" @onclick="CloseImageErrorModal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-danger">@ImageError</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseImageErrorModal">Đóng</button>
                </div>
            </div>
        </div>
    </div>


    <div class="form-group mb-3">
        <label for="ProductImages"><i class="fas fa-image"></i> Hình ảnh sản phẩm:</label>
        <div class="row">
            @for (int i = 0; i < 3; i++)
            {
                <div class="col-md-4">
                    <div class="image-preview border d-flex align-items-center justify-content-center" style="height: 200px;">
                        @if (selectedFiles.Count > i && selectedFiles[i] != null)
                        {
                            <img src="@selectedFiles[i].DataUrl" class="img-fluid" alt="Hình ảnh sản phẩm" />
                        }
                        else
                        {
                            <span class="placeholder-text">Chưa có hình ảnh</span>
                        }
                    </div>
                </div>
            }
        </div>
        <div class="row">
            <div class="col-md-2 d-flex align-items-center">
                <InputFile OnChange="HandleFileSelected" multiple accept="image/*" />
            </div>
            <div class="col-md-8 d-flex align-items-center">
                <span>Xem quy định về <a href="#"><i class="fas fa-info-circle"></i> Cách chụp ảnh và quay sản phẩm</a></span>
            </div>
        </div>
    </div>

    <div class="form-group mb-3">
        <label for="ProductName"><i class="fas fa-tag"></i> Tên sản phẩm:</label>
        <input type="text" @bind="ProductName" class="form-control" placeholder="Nhập tên sản phẩm" id="ProductName" />
        @if (!string.IsNullOrWhiteSpace(ProductNameError))
        {
            <div class="text-danger">@ProductNameError</div>
        }
    </div>

    <div class="form-group mb-3">
        <label for="ProductCategory"><i class="fas fa-box"></i> Loại sản phẩm:</label>
        <select @bind="ProductCategoryId" class="form-control" id="ProductCategory">
            <option value="">Chọn loại sản phẩm</option>
            @foreach (var category in categories)
            {
                <option value="@category.IDCategory">@category.NameCate</option>
            }
        </select>
        @if (!string.IsNullOrWhiteSpace(ProductCategoryError))
        {
            <div class="text-danger">@ProductCategoryError</div>
        }
    </div>

    <div class="form-group mb-3">
        <label for="ProductPrice"><img src="/AnhGiaoDien/business.png" style="width:16px;" /> Giá sản phẩm:</label>
        <input type="number" @bind="ProductPrice" class="form-control" placeholder="Nhập giá sản phẩm" id="ProductPrice" />
        @if (!string.IsNullOrWhiteSpace(ProductPriceError))
        {
            <div class="text-danger">@ProductPriceError</div>
        }
    </div>

    <div class="form-group mb-3">
        <label for="ProductQuantity"><i class="fas fa-sort-numeric-up"></i> Số lượng sản phẩm:</label>
        <input type="number" @bind="ProductQuantity" class="form-control" placeholder="Nhập số lượng sản phẩm" id="ProductQuantity" />
        @if (!string.IsNullOrWhiteSpace(ProductQuantityError))
        {
            <div class="text-danger">@ProductQuantityError</div>
        }
    </div>

    <div class="form-group mb-3">
        <label for="ProrityLevel"><i class="fas fa-exclamation"></i> Mức độ ưu tiên:</label>
        <select @bind="ProrityLevel" class="form-control" id="ProrityLevel">
            <option value="">Chọn mức độ ưu tiên</option>
            <option value="Phổ thông">Phổ thông</option>
            <option value="Ưu tiên">Ưu tiên</option>
        </select>
        @if (!string.IsNullOrWhiteSpace(ProrityLevelError))
        {
            <div class="text-danger">@ProrityLevelError</div>
        }
    </div>


    <div class="form-group">
        <label for="ProductDescription"><i class="fas fa-info-circle"></i> Mô tả sản phẩm chi tiết:</label>
        <textarea @bind="Description" class="form-control" id="ProductDescription" rows="4" placeholder="Nhập mô tả chi tiết về sản phẩm..."></textarea>

        <small class="form-text text-muted">
            <i class="fas fa-lightbulb"></i> Gợi ý:
            <ul>
                <li>Chất liệu: 100% cotton, mềm mại và thoáng khí.</li>
                <li>Thiết kế: Cổ áo đính cúc, tay dài có thể gấp lên dễ dàng.</li>
                <li>Màu sắc: Trắng, xanh dương, xám.</li>
                <li>Kích thước: S, M, L, XL.</li>
                <li>Chất lượng: Dệt chắc chắn, không phai màu sau nhiều lần giặt.</li>
            </ul>
        </small>
    </div>

    <div class="row">
        <div class="col-md-12 d-flex justify-content-end">
            <div class="text-right mb-3">
                <button @onclick="SaveProduct" class="btn btn-success"><i class="fas fa-check"></i> Đăng bán</button>
            </div>
        </div>
    </div>
</div>

@code {
    private string ProductName { get; set; }
    private decimal ProductPrice { get; set; }
    private int ProductQuantity { get; set; }
    private int ProductCategoryId { get; set; }
    private string Description { get; set; }
    private string ProrityLevel { get; set; }
    private List<Category> categories = new List<Category>();
    private List<ImageFile> selectedFiles = new List<ImageFile> { null, null, null };

    private string ProductNameError { get; set; }
    private string ProductCategoryError { get; set; }
    private string ProductPriceError { get; set; }
    private string ProductQuantityError { get; set; }
    private string ProrityLevelError { get; set; }
    private string ImageError { get; set; }


    private class ImageFile
    {
        public string DataUrl { get; set; }
    }
    private void CloseImageErrorModal()
    {
        ImageError = string.Empty; // Đóng modal bằng cách xóa lỗi
    }


    protected override async Task OnInitializedAsync()
    {
        try
        {
            await LoadUserData();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Có lỗi xảy ra khi tải dữ liệu: {ex.Message}");
        }
    }

    private async Task LoadUserData()
    {
        try
        {
            categories = await HttpClient.GetFromJsonAsync<List<Category>>("api/Category/GetCategories") ?? new List<Category>();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Không thể tải danh sách loại sản phẩm: {ex.Message}");
        }
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        try
        {
            var files = e.GetMultipleFiles(3);

            // Kiểm tra số lượng ảnh chọn được
            if (files.Count < 1 || files.Count > 3)
            {
                ImageError = "Bạn phải chọn ít nhất 1 ảnh và tối đa 3 ảnh.";
                selectedFiles.Clear();
                return; // Không tiếp tục xử lý nếu số lượng ảnh sai
            }

            // Đặt lại lỗi hình ảnh
            ImageError = string.Empty;

            foreach (var file in files)
            {
                for (int i = 0; i < selectedFiles.Count; i++)
                {
                    if (selectedFiles[i] == null)
                    {
                        selectedFiles[i] = new ImageFile
                            {
                                DataUrl = await GetImageDataUrl(file)
                            };
                        break;
                    }
                }
            }
        }
        catch (Exception ex)
        {
            ImageError = "Bạn phải chọn ít nhất 1 ảnh và tối đa 3 ảnh.";
            selectedFiles.Clear();
            return; // Không tiếp tục xử lý nếu số lượng ảnh sai
        }
    }


    private async Task<string> GetImageDataUrl(IBrowserFile file)
    {
        try
        {
            using var stream = file.OpenReadStream(maxAllowedSize: 1024 * 1024 * 3);
            var buffer = new byte[file.Size];
            await stream.ReadAsync(buffer);
            return $"data:{file.ContentType};base64,{Convert.ToBase64String(buffer)}";
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Không thể đọc dữ liệu hình ảnh: {ex.Message}");
            return string.Empty;
        }
    }

    private async Task SaveProduct()
    {
        // Reset lỗi
        ProductNameError = string.Empty;
        ProductCategoryError = string.Empty;
        ProductPriceError = string.Empty;
        ProductQuantityError = string.Empty;
        ProrityLevelError = string.Empty;

        // Kiểm tra dữ liệu
        if (string.IsNullOrWhiteSpace(ProductName))
        {
            ProductNameError = "Vui lòng nhập tên sản phẩm.";
        }

        if (ProductCategoryId == 0)
        {
            ProductCategoryError = "Vui lòng chọn loại sản phẩm.";
        }

        if (ProductPrice <= 0)
        {
            ProductPriceError = "Giá sản phẩm phải lớn hơn 0.";
        }

        if (ProductQuantity <= 0)
        {
            ProductQuantityError = "Số lượng sản phẩm phải lớn hơn 0.";
        }

        if (string.IsNullOrWhiteSpace(ProrityLevel))
        {
            ProrityLevelError = "Vui lòng chọn mức độ ưu tiên.";
        }
        var selectedImageCount = selectedFiles.Count(file => file != null);
        if (selectedImageCount < 1 || selectedImageCount > 3)
        {
            ImageError = "Bạn phải chọn ít nhất 1 ảnh và tối đa 3 ảnh.";
            selectedFiles.Clear();
            return; // Dừng lại và hiển thị modal
        }

        // Nếu có lỗi thì không tiếp tục
        if (!string.IsNullOrWhiteSpace(ProductNameError) ||
            !string.IsNullOrWhiteSpace(ProductCategoryError) ||
            !string.IsNullOrWhiteSpace(ProductPriceError) ||
            !string.IsNullOrWhiteSpace(ProductQuantityError) ||
            !string.IsNullOrWhiteSpace(ProrityLevelError))
        {
            return;
        }

        // Tiếp tục lưu sản phẩm
        try
        {
            var productDto = new ProductDto
                {
                    Name = ProductName,
                    Price = ProductPrice,
                    Quantity = ProductQuantity,
                    CategoryId = ProductCategoryId,
                    Description = Description,
                    ProrityLevel = ProrityLevel
                };

            var response = await HttpClient.PostAsJsonAsync("api/product/AddProduct", productDto);

            if (response.IsSuccessStatusCode)
            {
                var createdProduct = await response.Content.ReadFromJsonAsync<Product>();
                var productId = createdProduct?.IDProduct ?? 0;

                if (productId > 0)
                {
                    await UploadImages(productId);
                }
                else
                {
                    await JSRuntime.InvokeVoidAsync("alert", "Không thể lấy thông tin sản phẩm mới tạo.");
                }
            }
            else
            {
                var errorMessage = await response.Content.ReadAsStringAsync();
                await JSRuntime.InvokeVoidAsync("alert", $"Có lỗi xảy ra khi thêm sản phẩm: {errorMessage}");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Có lỗi xảy ra khi thêm sản phẩm: {ex.Message}");
        }
    }

    private async Task UploadImages(int productId)
    {
        try
        {
            var content = new MultipartFormDataContent();

            foreach (var file in selectedFiles)
            {
                if (file != null)
                {
                    var byteArray = Convert.FromBase64String(file.DataUrl.Split(",")[1]);
                    var fileContent = new ByteArrayContent(byteArray);
                    fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("image/jpeg");

                    content.Add(fileContent, "files", $"image_{Guid.NewGuid()}.jpg");
                }
            }

            var uploadResponse = await HttpClient.PostAsync($"api/ImageProduct/ImageProduct/{productId}/upload", content);

            if (uploadResponse.IsSuccessStatusCode)
            {
                await JSRuntime.InvokeVoidAsync("alert", "Sản phẩm đã được thêm thành công!");
                NavigationManager.NavigateTo("/", forceLoad: true);
            }
            else
            {
                var errorMessage = await uploadResponse.Content.ReadAsStringAsync();
                await JSRuntime.InvokeVoidAsync("alert", $"Có lỗi xảy ra khi tải ảnh: {errorMessage}");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Có lỗi xảy ra khi tải ảnh: {ex.Message}");
        }
    }
}
