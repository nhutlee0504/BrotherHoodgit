@page "/Admin/Bill"
@using SanGiaoDich_BrotherHood.Shared.Models
@layout AdminLayout
@inject HttpClient httpClient
@inject NavigationManager NavigationManager

<div class="container py-4">
    <h3 class="mb-4 text-center text-primary">Danh Sách Hóa Đơn</h3>

    <!-- Tìm kiếm -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="row gy-3">
                <div class="col-md-6">
                    <label for="searchByFullName" class="form-label">Tìm kiếm theo Họ và tên:</label>
                    <input id="searchByFullName" type="text" @bind="searchFullName" class="form-control" placeholder="Nhập họ và tên" />
                </div>
                <div class="col-md-4">
                    <label for="searchByIDBill" class="form-label">Tìm kiếm theo ID Hóa đơn:</label>
                    <input id="searchByIDBill" type="number" @bind="searchIDBill" class="form-control" placeholder="Nhập ID hóa đơn" />
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button class="btn btn-primary w-100" @onclick="SearchBills">Tìm kiếm</button>
                </div>
            </div>
        </div>
    </div>

    @if (bills == null)
    {
        <div class="text-center text-muted py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Đang tải dữ liệu...</p>
        </div>
    }
    else if (!bills.Any())
    {
        <div class="alert alert-warning text-center">
            Không có hóa đơn nào.
        </div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle">
                <thead class="table-primary">
                    <tr>
                        <th>#</th>
                        <th>Họ và tên</th>
                        <th>Số điện thoại</th>
                        <th>Địa chỉ giao hàng</th>
                        <th>Ngày đặt hàng</th>
                        <th>Hình thức thanh toán</th>
                        <th class="text-end">Tổng tiền</th>
                        <th>Trạng thái</th>
                        <th>Hành động</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var bill in bills)
                    {
                        <tr>
                            <td>@bill.IDBill</td>
                            <td>@bill.FullName</td>
                            <td>@bill.PhoneNumber</td>
                            <td>@bill.DeliveryAddress</td>
                            <td>@bill.OrderDate.ToString("dd/MM/yyyy")</td>
                            <td>@bill.PaymentType</td>
                            <td class="text-end">@bill.Total.ToString("C")</td>
                            <td>
                                <span class="badge @GetStatusBadgeClass(bill.Status)">@bill.Status</span>
                            </td>
                            <td>
                                <button class="btn btn-outline-primary btn-sm" @onclick="() => NavigateToBillDetails(bill.IDBill)">
                                    <i class="bi bi-eye"></i> Xem chi tiết
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {
    private List<Bill> bills;
    private List<Bill> allBills;
    private string searchFullName;
    private int? searchIDBill;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Lấy tất cả hóa đơn khi trang được khởi tạo
            allBills = await httpClient.GetFromJsonAsync<List<Bill>>("api/Bill/GetBill");
            bills = new List<Bill>(allBills); // Hiển thị tất cả hóa đơn khi chưa tìm kiếm
        }
        catch (Exception ex)
        {
            Console.WriteLine("Lỗi khi tải dữ liệu: " + ex.Message);
            bills = new List<Bill>();
        }
    }

    private async Task SearchBills()
    {
        try
        {
            if (!string.IsNullOrWhiteSpace(searchFullName))
            {
                bills = await httpClient.GetFromJsonAsync<List<Bill>>($"api/Bill/GetBillsByUserName/{searchFullName}");
            }
            else if (searchIDBill.HasValue)
            {
                var bill = await httpClient.GetFromJsonAsync<Bill>($"api/Bill/GetBillsByIDBill/{searchIDBill.Value}");
                bills = bill != null ? new List<Bill> { bill } : new List<Bill>();
            }
            else
            {
                bills = new List<Bill>(allBills);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine("Lỗi khi tìm kiếm hóa đơn: " + ex.Message);
            bills = new List<Bill>();
        }
    }

    private void NavigateToBillDetails(int IDBill)
    {
        NavigationManager.NavigateTo($"/Admin/BillDetails/{IDBill}");
    }

    private string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Đã giao" => "bg-success",
            "Đang xử lý" => "bg-warning",
            _ => "bg-secondary"
        };
    }

    public class Bill
    {
        public int IDBill { get; set; }
        public string FullName { get; set; }
        public string PhoneNumber { get; set; }
        public string DeliveryAddress { get; set; }
        public DateTime OrderDate { get; set; }
        public string PaymentType { get; set; }
        public decimal Total { get; set; }
        public string Status { get; set; }
    }
}
