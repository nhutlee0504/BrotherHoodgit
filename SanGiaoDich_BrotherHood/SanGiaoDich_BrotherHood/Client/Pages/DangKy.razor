@page "/dangky"
@using SanGiaoDich_BrotherHood.Shared.Dto
@using SanGiaoDich_BrotherHood.Shared.Models
@using System.Linq.Expressions
@using System.Reflection
@using System.ComponentModel.DataAnnotations
@inject HttpClient Http
<!-- CDN for Bootstrap 5 -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"></script>

<h3>Đăng Ký Tài Khoản</h3>

@if (!string.IsNullOrEmpty(Message))
{
    <div class="alert alert-danger">@Message</div>
}

<EditForm Model="registerDto" OnValidSubmit="HandleValidSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="form-group">
        <label for="UserName">Tên đăng nhập:</label>
        <InputText id="UserName" @bind-Value="registerDto.UserName" class="form-control" data-bs-toggle="tooltip" title="@GetErrorMessage(() => registerDto.UserName)" />
        <ValidationMessage For="@(() => registerDto.UserName)" />
    </div>

    <div class="form-group">
        <label for="Password">Mật khẩu:</label>
        <InputText id="Password" @bind-Value="registerDto.Password" type="password" class="form-control" data-bs-toggle="tooltip" title="@GetErrorMessage(() => registerDto.Password)" />
        <ValidationMessage For="@(() => registerDto.Password)" />
    </div>

    <div class="form-group">
        <label for="ConformPassword">Xác nhận mật khẩu:</label>
        <InputText id="ConformPassword" @bind-Value="registerDto.ConformPassword" type="password" class="form-control" data-bs-toggle="tooltip" title="@GetErrorMessage(() => registerDto.ConformPassword)" />
        <ValidationMessage For="@(() => registerDto.ConformPassword)" />
    </div>

    <button type="submit" class="btn btn-primary">Đăng ký</button>
</EditForm>


@if (registeredAccount != null)
{
    <h4>Thông tin tài khoản vừa đăng ký:</h4>
    <ul>
        <li><strong>Tên đăng nhập:</strong> @registeredAccount.UserName</li>
        <li><strong>Thời gian tạo:</strong> @registeredAccount.CreatedTime</li>
        <li><strong>Vai trò:</strong> @registeredAccount.Role</li>
    </ul>
}

@code {
    private RegisterDto registerDto = new RegisterDto();
    private string Message;
    private Account registeredAccount;

    private async Task HandleValidSubmit()
    {
        try
        {
            var response = await Http.PostAsJsonAsync("api/User/RegisterUser", registerDto);
            if (response.IsSuccessStatusCode)
            {
                registeredAccount = await response.Content.ReadFromJsonAsync<Account>();
                Message = string.Empty; // Reset message if registration is successful
            }
            else
            {
                var errorMessage = await response.Content.ReadAsStringAsync();
                Message = errorMessage; // Hiển thị thông báo lỗi từ server
            }
        }
        catch (Exception ex)
        {
            Message = $"Có lỗi xảy ra: {ex.Message}"; // Hiển thị thông báo lỗi chung
        }
    }

    private string GetErrorMessage(Expression<Func<string>> property)
    {
        var validationResults = new List<ValidationResult>();
        var context = new ValidationContext(registerDto) { MemberName = property.Body.ToString() };
        Validator.TryValidateObject(registerDto, context, validationResults, true);
        var errorMessage = validationResults.FirstOrDefault()?.ErrorMessage;
        return errorMessage;
    }

}
<!-- Tooltip CSS -->
<style>
    .form-control:invalid {
        border-color: #dc3545;
    }

    /* Style for tooltip */
    .form-control[data-bs-toggle="tooltip"]:not(:valid):hover {
        border-color: #dc3545;
        cursor: pointer;
    }

    .form-control[data-bs-toggle="tooltip"] {
        position: relative;
    }

        .form-control[data-bs-toggle="tooltip"]:hover::after {
            content: attr(title);
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            padding: 5px;
            background-color: #dc3545;
            color: white;
            font-size: 12px;
            border-radius: 5px;
            opacity: 1;
            visibility: visible;
        }
</style>
