@page "/gemini"

<div class="container mt-4">
    <h3>Tạo Mô Tả Sản Phẩm</h3>

    <div class="mb-3">
        <label for="inputText" class="form-label">Nhập Tên Sản Phẩm</label>
        <input id="inputText" class="form-control" @bind="InputText" placeholder="Nhập tên sản phẩm..." />
    </div>

    <button class="btn btn-primary" @onclick="GenerateDescriptionAsync" disabled="@IsLoading">
        @if (IsLoading)
        {
            <span class="spinner-border spinner-border-sm"></span>
        }
        else
        {
            <span>Tạo Mô Tả</span>
        }
    </button>

    <div class="mt-4">
        @if (FormattedResponse.Any())
        {
            <h5>Kết Quả:</h5>
            <ul>
                @foreach (var item in FormattedResponse)
                {
                    <li>@item</li>
                }
            </ul>
        }
        @if (!string.IsNullOrWhiteSpace(ErrorMessage))
        {
            <div class="alert alert-danger">@ErrorMessage</div>
        }
    </div>
</div>

@code {
    private string InputText { get; set; } = "";
    private List<string> FormattedResponse { get; set; } = new();
    private string ErrorMessage { get; set; } = "";
    private bool IsLoading { get; set; } = false;

    private async Task GenerateDescriptionAsync()
    {
        if (string.IsNullOrWhiteSpace(InputText))
        {
            ErrorMessage = "Vui lòng nhập tên sản phẩm!";
            return;
        }

        IsLoading = true;
        ErrorMessage = "";
        FormattedResponse.Clear();

        try
        {
            // API Key cho Gemini
            var apiKey = "AIzaSyC2r1g4eY-rSrBTkqeAhwRltlZJFk8sVzk";
            var url = $"https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key={apiKey}";

            // Payload gửi lên API Gemini
            var requestBody = new
            {
                contents = new[]
                {
                new
                {
                    parts = new[]
                    {
                        new { text = $"Tạo mô tả sản phẩm: {InputText}, dài vừa" }
                    }
                }
            }
            };

            using var httpClient = new HttpClient(); // Tạo HttpClient tạm thời để tránh ảnh hưởng từ cấu hình toàn cục
            var response = await httpClient.PostAsJsonAsync(url, requestBody);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<GeminiResponse>();
                var rawText = result?.candidates?.FirstOrDefault()?.content?.parts?.FirstOrDefault()?.text ?? "";
                FormattedResponse = rawText.Split(new[] { '\n', '*' }, StringSplitOptions.RemoveEmptyEntries)
                                           .Select(line => line.Trim())
                                           .Where(line => !string.IsNullOrWhiteSpace(line))
                                           .ToList();
            }
            else
            {
                ErrorMessage = $"Lỗi: {response.ReasonPhrase}";
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Đã xảy ra lỗi: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
        }
    }

    public class GeminiResponse
    {
        public Candidate[] candidates { get; set; }

        public class Candidate
        {
            public Content content { get; set; }

            public class Content
            {
                public Part[] parts { get; set; }

                public class Part
                {
                    public string text { get; set; }
                }
            }
        }
    }
}
