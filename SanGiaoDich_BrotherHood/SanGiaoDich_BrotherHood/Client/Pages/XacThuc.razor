@page "/facedetection"
@inject IJSRuntime JSRuntime

<h1>Face Detection Example</h1>

<!-- Nút bật camera -->
<button id="startButton">Bật Camera</button>

<!-- Video element để hiển thị video -->
<video id="video" width="640" height="480" autoplay></video>

<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

@code {
    // Khi trang tải xong, gọi hàm khởi tạo video và sự kiện
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("startButton"); // Gọi hàm startButton khi trang tải
        }
    }
}

<script>
    // Đảm bảo khi trang tải xong, script này sẽ chạy
    window.onload = async () => {
        if (typeof faceapi === 'undefined') {
            console.error("face-api.js not loaded correctly.");
            return;
        }

        // Tải các mô hình trước khi tiếp tục
        await faceapi.nets.ssdMobilenetv1.loadFromUri('/models');
        await faceapi.nets.faceLandmark68Net.loadFromUri('/models');
        await faceapi.nets.faceRecognitionNet.loadFromUri('/models');

        console.log("Các mô hình đã được tải thành công.");

        // Lắng nghe sự kiện click nút bật camera
        startButton(); // Gọi hàm startButton để đăng ký sự kiện
    };

    // Hàm khởi tạo camera
    async function startVideo() {
        const video = document.getElementById('video');

        // Kiểm tra xem trình duyệt có hỗ trợ getUserMedia không
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            console.error("Trình duyệt không hỗ trợ API getUserMedia");
            return;
        }

        try {
            // Yêu cầu quyền truy cập camera
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;

            // Khi video bắt đầu phát, gọi hàm nhận diện khuôn mặt
            video.onplaying = () => {
                detectFace(video);
            };
        } catch (err) {
            console.error("Không thể truy cập camera: ", err);
        }
    }

    // Hàm nhận diện khuôn mặt
    async function detectFace(videoElement) {
        const canvas = faceapi.createCanvasFromMedia(videoElement);
        document.body.append(canvas); // Tạo canvas để vẽ kết quả

        const displaySize = { width: videoElement.width, height: videoElement.height };
        faceapi.matchDimensions(canvas, displaySize);

        setInterval(async () => {
            const detections = await faceapi.detectAllFaces(videoElement)
                .withFaceLandmarks()
                .withFaceDescriptors();

            // Vẽ các kết quả nhận diện lên canvas
            const resizedDetections = faceapi.resizeResults(detections, displaySize);
            canvas?.clear();
            faceapi.draw.drawDetections(canvas, resizedDetections);
            faceapi.draw.drawFaceLandmarks(canvas, resizedDetections);
        }, 1000); // Cập nhật mỗi 100ms
    }

    // Đăng ký sự kiện click vào nút bật camera
    function startButton() {
        document.getElementById('startButton').addEventListener('click', startVideo);
    }
</script>
